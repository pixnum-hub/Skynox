<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Skynox Weather & AQI</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">

<style>
/* --------- BASE --------- */
*{box-sizing:border-box;font-family:system-ui;margin:0;padding:0}
body{min-height:100svh;display:flex;justify-content:center;align-items:flex-start;background:linear-gradient(135deg,#667eea,#764ba2);color:#000}
body.dark{background:#121212;color:#fff}
body.amoled{background:#000;color:#fff}

.app{
  width:100%;
  max-width:390px;
  padding:16px;
  border-radius:24px;
  border:1px solid rgba(255,255,255,.25);
  background:rgba(255,255,255,.18);
  backdrop-filter:blur(16px);
  display:flex;
  flex-direction:column;
  align-items:center;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  width:100%;
  margin-bottom:14px;
}

.toggle{
  width:36px;height:36px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.3);
  cursor:pointer;
}

/* Inputs & buttons */
input,button{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  margin-bottom:12px;
}
button{font-weight:bold;background:rgba(255,255,255,.35)}

/* Cards */
.card{
  background:rgba(255,255,255,.25);
  padding:14px;
  border-radius:18px;
  margin-bottom:14px;
  width:100%;
}
body.dark .card{background:rgba(255,255,255,.08)}
body.amoled .card{background:#111;border:1px solid rgba(255,255,255,.1)}

/* Small text */
.small{font-size:13px;opacity:.85}

/* Rows */
.row{display:flex;justify-content:space-between;margin-top:6px;font-size:14px}

/* Charts */
canvas{width:100%;height:120px}

/* AQI */
.aqi{
  padding:6px 10px;
  border-radius:999px;
  font-weight:bold;
  display:inline-block;
  margin-bottom:6px;
}
.good{background:#2ecc71;color:#fff}
.moderate{background:#f1c40f;color:#000}
.poor{background:#e67e22;color:#fff}
.severe{background:#e53935;color:#fff}

/* Banners */
.banner{
  display:none;
  padding:8px;
  border-radius:10px;
  margin-bottom:10px;
  text-align:center;
  font-size:13px;
}

/* Feels like text spacing fix */
#feels {
  margin-top:6px;
  margin-bottom:8px;
  font-size:14px;
  opacity:0.9;
}

/* Footer */
.footer{
  text-align:center;
  font-size:12px;
  opacity:.7;
  margin-top:6px;
}

/* Buttons & inputs AMOLED */
body.amoled input, body.amoled button{background:#222;color:#fff}
body.amoled .toggle{background:#333;color:#fff}
body.amoled .banner{background:#111;color:#fff}
</style>
</head>

<body>
<div class="app">

<div class="header">
  <h2>ğŸŒ¦ Skynox</h2>
  <div class="toggle" id="themeToggle">ğŸŒ™</div>
</div>

<div class="banner" id="updateBanner">New update available â€” tap to refresh</div>

<input id="cityInput" placeholder="Search city">
<button id="searchBtn">Search</button>
<button id="locBtn">ğŸ“ Use My Location</button>
<button id="installBtn">â¬‡ Install Skynox</button>

<h3 id="location">--</h3>
<h1 id="temp">--Â°</h1>
<p id="feels" class="small">Feels like --Â°</p>

<!-- Current Conditions -->
<div class="card">
  <h4>Current Conditions</h4>
  <div class="row"><span>ğŸ’§ Humidity</span><span id="humidity">--%</span></div>
  <div class="row"><span>ğŸŒ¬ Wind</span><span id="wind">-- km/h</span></div>
  <div class="row"><span>ğŸ§­ Direction</span><span id="windDir">--</span></div>
  <div class="row"><span>ğŸ’¨ Gust</span><span id="windGust">-- km/h</span></div>
  <div class="row"><span>â›… Clouds</span><span id="clouds">--%</span></div>
  <div class="row"><span>â˜€ï¸ UV Index</span><span id="uv">--</span></div>
  <div class="row"><span>â² Pressure</span><span id="pressure">-- hPa</span></div>
  <div class="row"><span>ğŸŒ§ Rain</span><span id="rain">-- mm</span></div>
  <div class="row"><span>â„ï¸ Snow</span><span id="snow">-- mm</span></div>
  <div class="row"><span>ğŸŒ™ Moon Phase</span><span id="moon">--</span></div>
  <div class="row"><span>ğŸ‘ Visibility</span><span id="visibility">-- km</span></div>
  <div class="row"><span>âš ï¸ Alerts</span><span id="alerts">--</span></div>
</div>

<!-- AQI -->
<div class="card">
  <h4>ğŸŒ« Air Quality</h4>
  <div id="aqiBadge" class="aqi">--</div>
  <p id="aqiText" class="small">--</p>
  <p id="maskTip" class="small">--</p>
  <p id="aqiTrend" class="small">--</p>
  <canvas id="aqiChart"></canvas>

  <h5 style="margin-top:10px">Hourly AQI</h5>
  <div id="aqiHourly" style="display:flex;gap:8px;overflow-x:auto;padding-bottom:6px;"></div>

  <div id="aqiDetails" class="small"></div>
  <div style="margin-top:6px">
    <div class="row"><span>PM2.5</span><span id="pm25">-- Âµg/mÂ³</span></div>
    <div class="row"><span>PM10</span><span id="pm10">-- Âµg/mÂ³</span></div>
    <div class="row"><span>Oâ‚ƒ</span><span id="o3">-- Âµg/mÂ³</span></div>
    <div class="row"><span>NOâ‚‚</span><span id="no2">-- Âµg/mÂ³</span></div>
  </div>
  <div class="small" id="aqiAdvice" style="margin-top:8px"></div>

  <div style="height:8px;border-radius:8px;overflow:hidden;margin-top:6px;background:#ddd">
    <div id="aqiBar" style="height:100%;width:0%"></div>
  </div>
</div>

<!-- 24h Temperature -->
<div class="card">
  <h4>Next 24h Temperature</h4>
  <p id="hourMinMax" class="small">--</p>
  <canvas id="hourlyChart"></canvas>
</div>

<!-- 7-Day Forecast -->
<div class="card">
  <h4>7-Day Forecast</h4>
  <div id="forecast"></div>
</div>

<div class="footer">Â© Manik Roy 2025. All Rights Reserved.</div>
</div>

<script>
/* ---------------- THEME ---------------- */
let mode=0;
const body=document.body;
const toggle=document.getElementById("themeToggle");
function applyTheme(){
  body.className="";
  if(mode===1) body.classList.add("dark");
  if(mode===2) body.classList.add("amoled");
  toggle.textContent = mode===0 ? "ğŸŒ™" : mode===1 ? "ğŸŒ‘" : "â˜€ï¸";
}
toggle.onclick=()=>{mode=(mode+1)%3;applyTheme();}
applyTheme();

/* ---------------- SERVICE WORKER ---------------- */
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("sw.js");
  navigator.serviceWorker.addEventListener("controllerchange",()=>{
    updateBanner.style.display="block";
    updateBanner.onclick=()=>location.reload();
  });
}

/* ---------------- INSTALL ---------------- */
let deferredPrompt;
window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();
  deferredPrompt=e;
  installBtn.style.display="block";
});
installBtn.onclick=async()=>{
  if(!deferredPrompt)return;
  await deferredPrompt.prompt();
  deferredPrompt=null;
};

/* ---------------- AQI HELPERS ---------------- */
function pm25ToAQI(pm){
const bp=[[0,12,0,50],[12.1,35.4,51,100],[35.5,55.4,101,150],[55.5,150.4,151,200],[150.5,250,201,300]];
for(const[bL,bH,aL,aH]of bp) if(pm>=bL&&pm<=bH) return Math.round(((aH-aL)/(bH-bL))*(pm-bL)+aL);
return 300;
}
function aqiInfo(a){
if(a<=50)return["Good","good","Air quality is good","ğŸ˜Œ No mask"];
if(a<=100)return["Moderate","moderate","Sensitive people be cautious","ğŸ˜ Optional mask"];
if(a<=150)return["Unhealthy (Sensitive)","poor","Reduce outdoor activity","ğŸ˜· Mask advised"];
return["Unhealthy","severe","Avoid outdoor activity","ğŸ˜· N95 recommended"];
}
function aqiHealthAdvice(aqi){if(aqi<=50)return "Air quality is ideal for outdoor activities.";if(aqi<=100)return "Sensitive individuals should limit prolonged exertion.";if(aqi<=150)return "Children, elderly & asthmatics should reduce outdoor activity.";if(aqi<=200)return "Everyone should avoid long outdoor exertion.";return "Health alert: Stay indoors and keep windows closed.";}
function aqiColor(a){return a<=50?"#2ecc71":a<=100?"#f1c40f":a<=150?"#e67e22":a<=200?"#e53935":"#6d0019";}
function aqiIcon(a){return a<=50?"ğŸ˜Š":a<=100?"ğŸ˜":a<=150?"ğŸ˜·":a<=200?"ğŸ¤¢":"â˜ ï¸";}

/* ---------------- CHART ---------------- */
function drawChart(id,arr,color){
const c=document.getElementById(id),ctx=c.getContext("2d");
c.width=c.offsetWidth;c.height=120;
ctx.clearRect(0,0,c.width,c.height);
const min=Math.min(...arr),max=Math.max(...arr),r=max-min||1;
arr.forEach((v,i)=>{
const h=((v-min)/r)*c.height;
ctx.fillStyle=color;
ctx.fillRect(i*(c.width/arr.length),c.height-h,c.width/arr.length-2,h);
});
}

/* ---------------- LOAD WEATHER ---------------- */
let lastLat,lastLon,autoAQI;
async function loadWeather(lat,lon,name){
lastLat=lat;lastLon=lon;
const w=await fetch(
`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relativehumidity_2m,windspeed_10m,winddirection_10m,pressure_msl,cloudcover_0_1h,uv_index_0_1h,precipitation_1h,snowfall_1h,visibility_0_1km&daily=temperature_2m_min,temperature_2m_max,moon_phase&timezone=auto`
).then(r=>r.json());
const a=await fetch(
`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5,pm10,ozone,nitrogen_dioxide&timezone=auto`
).then(r=>r.json());
localStorage.setItem("skynox_cache",JSON.stringify({lat,lon,name,w,a}));

location.textContent=name;
temp.textContent=Math.round(w.current_weather.temperature)+"Â°C";
feels.textContent="Feels like "+Math.round(w.current_weather.temperature)+"Â°C";
humidity.textContent=w.hourly.relativehumidity_2m[0]+"%";
wind.textContent=w.hourly.windspeed_10m[0]+" km/h";
windDir.textContent=w.hourly.winddirection_10m[0]+"Â°";
pressure.textContent=Math.round(w.hourly.pressure_msl[0])+" hPa";
clouds.textContent=w.hourly.cloudcover_0_1h ? w.hourly.cloudcover_0_1h[0]+"%" : "--";
uv.textContent=w.hourly.uv_index_0_1h ? w.hourly.uv_index_0_1h[0] : "--";
rain.textContent=w.hourly.precipitation_1h ? w.hourly.precipitation_1h[0]+" mm" : "--";
snow.textContent=w.hourly.snowfall_1h ? w.hourly.snowfall_1h[0]+" mm" : "--";
windGust.textContent=w.hourly.windspeed_10m ? w.hourly.windspeed_10m[0]+" km/h" : "--";
visibility.textContent=w.hourly.visibility_0_1km ? (w.hourly.visibility_0_1km[0]/1000).toFixed(1)+" km" : "--";
moon.textContent=w.daily ? ["New","Waxing Crescent","First Quarter","Waxing Gibbous","Full","Waning Gibbous","Last Quarter","Waning Crescent"][Math.floor(w.daily.moon_phase[0]*7)] || "--" : "--";
alerts.textContent=w.alerts && w.alerts.length ? w.alerts.map(a=>a.event).join(", ") : "None";

/* AQI */
const pm=a.hourly.pm2_5[0];
const aqi=pm25ToAQI(pm);
const [label,cls,text,mask]=aqiInfo(aqi);
aqiBadge.className="aqi "+cls;
aqiBadge.textContent="AQI "+aqi+" Â· "+label;
aqiText.textContent=text;
maskTip.textContent=mask;
aqiTrend.textContent="Based on last hour";
drawChart("aqiChart",a.hourly.pm2_5.slice(0,24).map(pm25ToAQI),"#e53935");
aqiBar.style.width=Math.min(aqi/3,100)+"%";
aqiBar.style.background=aqiColor(aqi);
pm25.textContent=a.hourly.pm2_5[0]+" Âµg/mÂ³";
pm10.textContent=a.hourly.pm10[0]+" Âµg/mÂ³";
o3.textContent=a.hourly.ozone[0]+" Âµg/mÂ³";
no2.textContent=a.hourly.nitrogen_dioxide[0]+" Âµg/mÂ³";
aqiDetails.textContent="Primary pollutant: "+(a.hourly.pm2_5[0]>a.hourly.pm10[0]?"PM2.5":"PM10");
aqiAdvice.textContent=aqiHealthAdvice(aqi);

const hourlyAQI=a.hourly.pm2_5.slice(0,24).map(pm25ToAQI);
aqiHourly.innerHTML=hourlyAQI.map((v,i)=>`<div style="min-width:56px;padding:8px;border-radius:12px;background:${aqiColor(v)};color:#fff;text-align:center;font-size:12px"><div>${aqiIcon(v)}</div><strong>${v}</strong><div>${i}:00</div></div>`).join("");

// 24h Temperature
const t24=w.hourly.temperature_2m.slice(0,24);
hourMinMax.textContent=`Min ${Math.min(...t24)}Â° / Max ${Math.max(...t24)}Â°`;
drawChart("hourlyChart",t24,"#42a5f5");

// 7-Day Forecast
const daily=w.daily;
if(daily && daily.temperature_2m_max && daily.temperature_2m_min){
  forecast.innerHTML = daily.temperature_2m_max.map((maxTemp,i) => {
    const minTemp = daily.temperature_2m_min[i];
    return `<div class="row"><span>Day ${i+1}</span><span>${maxTemp}Â° / ${minTemp}Â°</span></div>`;
  }).join("");
} else {
  forecast.innerHTML = "<p class='small'>7-day forecast not available</p>";
}
}

/* ---------------- EVENTS ---------------- */
locBtn.onclick=()=>navigator.geolocation.getCurrentPosition(p=>{
  loadWeather(p.coords.latitude,p.coords.longitude,"Current Location");
  clearInterval(autoAQI);
  autoAQI=setInterval(()=>loadWeather(p.coords.latitude,p.coords.longitude,"Current Location"),15*60*1000);
});

searchBtn.onclick=async()=>{
const q=cityInput.value.trim();if(!q)return;
const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1`).then(r=>r.json());
if(r.results)loadWeather(r.results[0].latitude,r.results[0].longitude,r.results[0].name);
};

const cache=JSON.parse(localStorage.getItem("skynox_cache")||"null");
cache?loadWeather(cache.lat,cache.lon,cache.name):loadWeather(28.61,77.23,"Delhi, India");
</script>
</body>
</html>
