<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Skynox Weather & AQI</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">

<style>
*{box-sizing:border-box;font-family:system-ui;margin:0;padding:0}
body{
  min-height:100svh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:linear-gradient(135deg,#667eea,#764ba2);
}
body.dark{background:#121212}
body.amoled{background:#000}

.app{
  width:100%;
  max-width:390px;
  padding:16px;
  border-radius:24px;
  border:1px solid rgba(255,255,255,.25);
  background:rgba(255,255,255,.18);
  backdrop-filter:blur(16px);
  color:#000;
}
body.dark .app, body.amoled .app{
  background:rgba(0,0,0,.6);
  color:#fff;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px;
}
.toggle{
  width:36px;height:36px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.3);
  cursor:pointer;
}

input,button{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  margin-bottom:12px;
}
button{font-weight:bold;background:rgba(255,255,255,.35)}

.card{
  background:rgba(255,255,255,.25);
  padding:14px;
  border-radius:18px;
  margin-bottom:14px;
}
body.dark .card, body.amoled .card{
  background:rgba(255,255,255,.08);
}

canvas{width:100%;height:120px}

.aqi{padding:6px 10px;border-radius:999px;font-weight:bold;display:inline-block}

.footer{
  text-align:center;
  font-size:12px;
  opacity:.7;
  margin-top:8px;
}

#installBtn{display:none;background:#000;color:#fff}
#updateBanner{display:none;padding:8px;border-radius:10px;background:#000;color:#fff;margin-bottom:10px;text-align:center}
</style>
</head>

<body>
<div class="app">

<div class="header">
  <h2>ğŸŒ¦ Skynox</h2>
  <div class="toggle" id="themeToggle">ğŸŒ™</div>
</div>

<div id="updateBanner">New update available â€” tap to refresh</div>

<input id="cityInput" placeholder="Search city">
<button id="searchBtn">Search</button>
<button id="locBtn">ğŸ“ Use My Location</button>
<button id="installBtn">â¬‡ Install Skynox</button>

<h3 id="location">--</h3>
<h1 id="temp">--Â°</h1>
<p id="feels">--</p>

<div class="card">
  <h4>ğŸŒ« Air Quality</h4>
  <div id="aqiBadge" class="aqi">--</div>
  <p id="aqiText">--</p>
  <canvas id="aqiChart"></canvas>
</div>

<div class="card">
  <h4>Next 24h Temperature</h4>
  <p id="hourMinMax">--</p>
  <canvas id="hourlyChart"></canvas>
</div>

<div class="card">
  <h4>7-Day Forecast</h4>
  <div id="forecast"></div>
</div>

<div class="footer">Â© Manik Roy 2025. All Rights Reserved.</div>
</div>

<script>
/* ---------------- THEME TOGGLE ---------------- */
let mode=0;
const body=document.body;
const icon=document.getElementById("themeToggle");
function applyTheme(){
  body.className=mode===0?"":mode===1?"dark":"amoled";
  icon.textContent=mode===0?"ğŸŒ™":mode===1?"ğŸŒ‘":"â˜€ï¸";
}
icon.onclick=()=>{mode=(mode+1)%3;applyTheme()};
applyTheme();

/* ---------------- SERVICE WORKER ---------------- */
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("sw.js");
  navigator.serviceWorker.addEventListener("controllerchange",()=>{
    document.getElementById("updateBanner").style.display="block";
    updateBanner.onclick=()=>location.reload();
  });
}

/* ---------------- INSTALL ---------------- */
let deferredPrompt;
window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();
  deferredPrompt=e;
  installBtn.style.display="block";
});
installBtn.onclick=async()=>{
  if(!deferredPrompt)return;
  await deferredPrompt.prompt();
  deferredPrompt=null;
};

/* ---------------- AQI ---------------- */
function pm25ToAQI(pm){
const bp=[[0,12,0,50],[12.1,35.4,51,100],[35.5,55.4,101,150],[55.5,150.4,151,200]];
for(const[bL,bH,aL,aH]of bp)
if(pm>=bL&&pm<=bH)return Math.round(((aH-aL)/(bH-bL))*(pm-bL)+aL);
return 200;
}

/* ---------------- DRAW CHART ---------------- */
function drawChart(id,arr,color){
const c=document.getElementById(id),ctx=c.getContext("2d");
c.width=c.offsetWidth;c.height=120;
ctx.clearRect(0,0,c.width,c.height);
const min=Math.min(...arr),max=Math.max(...arr),r=max-min||1;
arr.forEach((v,i)=>{
const h=((v-min)/r)*c.height;
ctx.fillStyle=color;
ctx.fillRect(i*(c.width/arr.length),c.height-h,c.width/arr.length-2,h);
});
}

/* ---------------- LOAD WEATHER ---------------- */
async function loadWeather(lat,lon,name){
const w=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m&daily=temperature_2m_min,temperature_2m_max&timezone=auto`).then(r=>r.json());
const a=await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5&timezone=auto`).then(r=>r.json());

location.textContent=name;
temp.textContent=Math.round(w.current_weather.temperature)+"Â°C";
feels.textContent="Feels like "+Math.round(w.current_weather.temperature)+"Â°C";

const t24=w.hourly.temperature_2m.slice(0,24);
hourMinMax.textContent=`Min ${Math.min(...t24)}Â° / Max ${Math.max(...t24)}Â°`;
drawChart("hourlyChart",t24,"#42a5f5");

const pm=a.hourly.pm2_5[0];
const aqi=pm25ToAQI(pm);
aqiBadge.textContent="AQI "+aqi;
aqiText.textContent="PM2.5: "+pm+" Âµg/mÂ³";
drawChart("aqiChart",a.hourly.pm2_5.slice(0,24).map(pm25ToAQI),"#e53935");

forecast.innerHTML=w.daily.temperature_2m_max.map((_,i)=>
`<div>Day ${i+1}: ${w.daily.temperature_2m_max[i]}Â° / ${w.daily.temperature_2m_min[i]}Â°</div>`
).join("");
}

locBtn.onclick=()=>navigator.geolocation.getCurrentPosition(p=>loadWeather(p.coords.latitude,p.coords.longitude,"Current Location"));
searchBtn.onclick=async()=>{
const q=cityInput.value.trim();if(!q)return;
const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1`).then(r=>r.json());
if(r.results)loadWeather(r.results[0].latitude,r.results[0].longitude,r.results[0].name);
};

loadWeather(28.61,77.23,"Delhi, India");
</script>
</body>
</html>
