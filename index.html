<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Skynox</title>
<meta name="theme-color" content="#667eea">
<link rel="manifest" href="manifest.json">

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

<style>
*{box-sizing:border-box;font-family:system-ui,sans-serif;margin:0;padding:0;}
body{min-height:100vh;display:flex;justify-content:center;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);}
.app{width:100%;max-width:390px;min-height:100vh;padding:16px;border-radius:22px;background:rgba(255,255,255,.18);backdrop-filter:blur(16px);color:#000;}

input,button{width:100%;padding:12px;border-radius:12px;border:none;margin-bottom:10px;}
button{font-weight:bold;background:rgba(255,255,255,.35);}
#installBtn{display:none;background:#000;color:#fff;}

.card{background:rgba(255,255,255,.25);padding:12px;border-radius:16px;margin-bottom:12px;}
canvas{width:100%;height:120px;border-radius:12px;}

.aqi{padding:6px 10px;border-radius:999px;font-weight:bold;display:inline-block;}
.good{background:#2ecc71;color:#fff;}
.moderate{background:#f1c40f;color:#000;}
.poor{background:#e67e22;color:#fff;}
.severe{background:#e53935;color:#fff;}

.expand{max-height:0;overflow:hidden;transition:max-height .3s ease;}
.expand.open{max-height:700px;}

.hour-row{display:flex;justify-content:space-between;font-size:12px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.2);}
.marker{font-weight:bold;font-size:11px;}
.min{color:#42a5f5;}
.max{color:#e53935;}

.banner.alert{display:none;padding:8px;border-radius:10px;font-size:13px;text-align:center;margin-bottom:10px;color:#fff;}

@media(prefers-color-scheme:dark){
body{background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);}
.app{background:rgba(0,0,0,.35);color:#fff;}
}
</style>
</head>

<body>
<div class="app">

<h1>üå¶ Skynox</h1>

<input id="cityInput" placeholder="Search city">
<button id="searchBtn">Search</button>
<button id="locBtn">üìç Use My Location</button>
<button id="installBtn">‚¨á Install Skynox</button>

<h2 id="location">--</h2>
<p id="temp">--¬∞</p>

<!-- AQI HEALTH ALERT -->
<div class="banner alert" id="aqiAlert"></div>

<!-- AQI CARD -->
<div class="card">
<h4>üå´ Air Quality</h4>
<div id="aqiBadge" class="aqi">--</div>
<p id="aqiPM">--</p>
<p id="aqiTrend">--</p>
<p id="aqiText" style="font-size:13px;margin-top:4px">--</p>
<div class="aqi-bar"><span id="aqiFill"></span></div>
<div id="maskTip" class="mask-tip">--</div>
<canvas id="aqiChart"></canvas>
</div>

<!-- NEXT 24H -->
<div class="card" id="hourlyCard">
<h4>Next 24h Temperature</h4>
<small id="hourlyMinMax">--</small>
<canvas id="hourlyChart"></canvas>
<div id="hourlyExpand" class="expand"></div>
</div>

<!-- 7-DAY FORECAST -->
<h3>üìÖ 7-Day Forecast</h3>
<div id="forecast"></div>

</div>

<script>
// ===== HELPERS =====
const $ = id => document.getElementById(id);

// PM2.5 ‚Üí AQI conversion
function pm25ToAQI(pm){
  const bp=[[0,12,0,50],[12.1,35.4,51,100],[35.5,55.4,101,150],[55.5,150.4,151,200],[150.5,250.4,201,300],[250.5,500,301,500]];
  for(const [cL,cH,aL,aH] of bp){
    if(pm>=cL && pm<=cH) return Math.round(((aH-aL)/(cH-cL))*(pm-cL)+aL);
  }
  return 500;
}
function aqiInfo(aqi){
  if(aqi<=50) return ["Good","good","#2ecc71","Air quality is good"];
  if(aqi<=100) return ["Moderate","moderate","#f1c40f","Sensitive people should take caution"];
  if(aqi<=150) return ["Unhealthy (Sensitive)","poor","#e67e22","Reduce outdoor activity"];
  if(aqi<=200) return ["Unhealthy","severe","#e53935","Avoid outdoor activity"];
  if(aqi<=300) return ["Very Unhealthy","severe","#8e24aa","Stay indoors"];
  return ["Hazardous","severe","#6d0019","Health emergency"];
}

// ===== CHARTS =====
function drawChart(id,values,color="#42a5f5"){
  const c=$(id),ctx=c.getContext("2d");
  c.width=c.offsetWidth; c.height=120;
  ctx.clearRect(0,0,c.width,c.height);
  const min=Math.min(...values),max=Math.max(...values),r=max-min||1;
  values.forEach((v,i)=>{
    const h=((v-min)/r)*c.height;
    ctx.fillStyle=color;
    ctx.fillRect(i*(c.width/values.length),c.height-h,c.width/values.length-2,h);
  });
}

// ===== LOAD WEATHER + AQI =====
async function loadWeather(lat,lon,name){
  $("aqiAlert").style.display="none";
  try{
    const w=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relativehumidity_2m,windspeed_10m&daily=temperature_2m_min,temperature_2m_max&timezone=auto`).then(r=>r.json());
    const a=await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5&timezone=auto`).then(r=>r.json());

    localStorage.setItem("skynox_cache",JSON.stringify({lat,lon,name,weather:w,air:a,time:Date.now()}));

    $("location").textContent=name;
    $("temp").textContent=Math.round(w.current_weather.temperature)+"¬∞C";

    // ----- NEXT 24H -----
    const t24=w.hourly.temperature_2m.slice(0,24);
    $("hourlyMinMax").textContent=`Min ${Math.min(...t24)}¬∞ / Max ${Math.max(...t24)}¬∞`;
    drawChart("hourlyChart",t24);

    const exp=$("hourlyExpand"); exp.innerHTML="";
    const minT=Math.min(...t24),maxT=Math.max(...t24);
    for(let i=0;i<24;i++){
      let tag="";
      if(t24[i]===minT) tag=`<span class="marker min">‚óè MIN</span>`;
      if(t24[i]===maxT) tag=`<span class="marker max">‚óè MAX</span>`;
      exp.innerHTML+=`<div class="hour-row"><span>${i}:00</span><span>${t24[i]}¬∞ ${tag}</span><span>${w.hourly.relativehumidity_2m[i]}%</span><span>${w.hourly.windspeed_10m[i]} km/h</span></div>`;
    }

    // ----- AQI -----
    const pmNow=a.hourly.pm2_5[0];
    const pmPrev=a.hourly.pm2_5[1]??pmNow;
    const aqiNow=pm25ToAQI(pmNow);
    const aqiPrev=pm25ToAQI(pmPrev);
    const [label,cls,color,advice]=aqiInfo(aqiNow);

    $("aqiBadge").className="aqi "+cls;
    $("aqiBadge").textContent=`AQI ${aqiNow} ¬∑ ${label}`;
    $("aqiPM").textContent=`PM2.5: ${pmNow} ¬µg/m¬≥`;
    $("aqiText").textContent=advice;
    $("aqiFill").style.width=Math.min(aqiNow/5,100)+"%";
    $("aqiFill").style.background=color;
    $("maskTip").textContent=aqiNow<=50?"üòå No mask":aqiNow<=100?"üòê Sensitive mask":aqiNow<=150?"üò∑ Recommended":"üò∑ N95 advised";
    $("aqiTrend").textContent=aqiNow>aqiPrev?"‚Üë Worsening":aqiNow<aqiPrev?"‚Üì Improving":"‚Üí Stable";

    // ----- Health banner -----
    const alertBanner=$("aqiAlert");
    alertBanner.style.display="block";
    alertBanner.textContent=advice;
    alertBanner.style.background=color;

    drawChart("aqiChart",a.hourly.pm2_5.slice(0,24).map(pm25ToAQI),color);

    // ----- Forecast -----
    const f=$("forecast"); f.innerHTML="";
    w.daily.temperature_2m_max.forEach((_,i)=>{
      f.innerHTML+=`<div class="card">Day ${i+1}: ${w.daily.temperature_2m_max[i]}¬∞ / ${w.daily.temperature_2m_min[i]}¬∞</div>`;
    });

  }catch(e){
    const c=JSON.parse(localStorage.getItem("skynox_cache")||"null");
    if(c) loadWeather(c.lat,c.lon,c.name);
    else alert("Network error. Check internet.");
  }
}

// ===== SEARCH & LOCATION =====
$("searchBtn").onclick=async()=>{
  const q=$("cityInput").value.trim();
  if(!q) return;
  const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1`).then(r=>r.json());
  if(r.results) loadWeather(r.results[0].latitude,r.results[0].longitude,r.results[0].name);
};
$("locBtn").onclick=()=>navigator.geolocation.getCurrentPosition(p=>loadWeather(p.coords.latitude,p.coords.longitude,"Current Location"));

// ===== HOURLY EXPAND =====
$("hourlyCard").onclick=()=>$("hourlyExpand").classList.toggle("open");

// ===== BOOT =====
loadWeather(28.61,77.23,"Delhi, India");
</script>

</body>
</html>
